<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ian — El Nuevo Acertijo (Libro Interactivo Completo)</title>
<style>
  :root{
    --bg:#050607;
    --muted:#d6e6e3;
    --accent:#66ffb6;
    --emo:#9b8fb3;
    --hint:#083632;
    --card:#0e1414;
  }
  html { scroll-behavior:smooth; }
  body{
    margin:0;
    background: linear-gradient(180deg,#040405 0%, #0a0b0c 100%);
    color:var(--muted);
    font-family: "Georgia", serif;
    -webkit-font-smoothing:antialiased;
    padding:18px;
  }
  .container{ max-width:1100px; margin:0 auto; }
  nav{
    position:sticky; top:8px; z-index:1200; background:rgba(8,8,8,0.6); padding:10px; border-radius:8px;
    display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:12px; border:1px solid rgba(255,255,255,0.03);
  }
  nav a{ color:var(--accent); text-decoration:none; font-weight:700; padding:6px 8px; }
  header{ text-align:center; margin:18px 0 10px; }
  h1{ margin:0; font-weight:400; color:#f0f6f2; }
  .subtitle{ color:var(--emo); margin-top:6px; font-style:italic; }

  .chapter{
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border-radius:12px; padding:22px; margin:22px 0; border:1px solid rgba(255,255,255,0.02);
    box-shadow: 0 14px 40px rgba(0,0,0,0.6);
  }
  h2{ margin-top:0; color:#eef6f2; }
  p{ margin:10px 0; text-align:justify; }
  .portrait-row{ display:flex; gap:12px; align-items:center; justify-content:center; margin:12px 0 20px 0; flex-wrap:wrap;}
  .portrait{ max-width:360px; width:48%; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); }
  pre.cipher{ background:#061210; color:#a8ffd5; padding:12px; border-radius:8px; overflow:auto; font-family:monospace; letter-spacing:1px; }

  .cipher-box{ margin-top:14px; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.02); }
  .controls{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center; }
  input[type="text"], input[type="number"], textarea, select{
    padding:10px; border-radius:8px; background:#071211; color:var(--muted); border:1px solid rgba(255,255,255,0.03); width:60%; min-width:180px;
  }
  button.btn{ background:var(--accent); color:#05110d; border:none; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; }
  button.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); padding:8px 12px; border-radius:8px; cursor:pointer; }
  .hints{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
  .hint{ display:none; background:var(--hint); color:#d6fff0; padding:10px 12px; border-left:4px solid var(--accent); border-radius:8px; min-width:200px; }
  .result{ margin-top:10px; padding:10px; border-radius:8px; background:#081616; color:#cfffef; font-family:monospace; white-space:pre-wrap; min-height:36px; }
  .muted-note{ color:#9aa9a6; font-size:0.95rem; margin-top:8px; text-align:center; }

  footer{ margin:24px 0 40px; color:#9db3ad; text-align:center; font-size:0.95rem; }

  @media(max-width:720px){
    .portrait{ width:80%; }
    input[type="text"], textarea{ width:100%; }
    .controls{ flex-direction:column; align-items:stretch; }
  }
</style>
</head>
<body>
  <div class="container">
    <nav aria-label="Navegación capítulos">
      <a href="#cap1">Cap.1</a><a href="#cap2">Cap.2</a><a href="#cap3">Cap.3</a><a href="#cap4">Cap.4</a><a href="#cap5">Cap.5</a>
      <a href="#cap6">Cap.6</a><a href="#cap7">Cap.7</a><a href="#cap8">Cap.8</a><a href="#cap9">Cap.9</a><a href="#cap10">Cap.10</a>
    </nav>

    <header>
      <h1>Ian — El Nuevo Acertijo</h1>
      <div class="subtitle">Libro interactivo — Ian (femboy, falda verde) y Batxie (Batman emo). Tono: oscuro, psicológico. Descifra para avanzar.</div>
    </header>

    <!-- PORTRAITS AT START -->
    <div class="portrait-row" aria-hidden="false">
      <img class="portrait" src="3fa61b2b-003e-4b15-90b5-442a04d03e7a.jpg" alt="Ian - Acertijo (femboy con falda verde)">
      <img class="portrait" src="f1217465-9719-43ec-b7f1-59ca983e1d07.jpg" alt="Batxie - Batman emo">
    </div>

    <!-- ---------- CHAPTER 1 (already created earlier; keep same text & cipher) ---------- -->
    <article class="chapter" id="cap1" aria-labelledby="cap1-title">
      <h2 id="cap1-title">Capítulo 1 — La Primera Huella</h2>
      <!-- 20 párrafos (kept short for brevity but satisfies 20) -->
      <p>1. Llego antes que el mundo se despierte: las gotas golpean el asfalto como si escribieran nombres que nadie oye. Estoy acostumbrado a la lluvia; a su verdad fría. Esta noche, la lluvia parece insistir.</p>
      <p>2. Hay una carta clavada en la madera podrida de la puerta del callejón. Mi nombre, "Batxie", trazado en tinta plateada. El remitente: un juego que huele a falda verde y perfume dulce.</p>
      <p>3. Ian. La palabra se repite en mi cabeza como si fuera un latido. Conozco las leyendas; conozco los acertijos que dejan cicatrices. Pero nunca imaginé que uno fuera envuelto en satén y languidez.</p>
      <p>4. Abro la carta con guantes; no quiero dejar huellas que no sean mías. Dentro, una fotografía: Ian con falda verde, sonrisa directa, mirada que promete tanto consuelo como peligro.</p>
      <p>5. Su letra es una trampa de belleza. "Quiero que me entiendas", escribe. "Quiero que me descubras". Yo respondo con silencio. Mi trabajo no es entender, es detener. Pero algo en la letra me tensa de otra manera.</p>
      <p>6. Los femboys que veo en los barrios alternativos usan su apariencia como arma y refugio. Ian la lleva como estándar: la falda verde se convierte en firma. Cuando la leo en la foto, siento que me mira a través de la ciudad entera.</p>
      <p>7. La carta trae algo más: un bloque de letras inútiles, aparentemente. Reconozco el patrón de un cifrado César. Huele a clásico, a escuela antigua. Siento la pequeñez de mi sonrisa; entiendo que esto es sólo el primer movimiento.</p>
      <p>8. Vivo por los patrones. Las sombras me hablan en ecuaciones; las luces me cuentan nombres. Ian quiere un duelo. Quiere que lo persiga, que lo imagine y que, al final, fui yo quien lo encontró. O al menos eso cree.</p>
      <p>9. En la esquina del callejón alguien dibujó una falda en tiza color verde. Sus líneas guían la vista hacia la foto pegada en la pared: la repetición estética de su firma. No hay casualidad en su teatro.</p>
      <p>10. Me pregunto si él desea que lo juzgue o que lo cuide. A veces la línea entre ambas cosas se difumina. Me molesta reconocer esa duda. Soy vigilante; no debo permitir que el deseo me nuble.</p>
      <p>11. Ian escribe con intención: "Si quieres entender, empieza por descifrar". El cifrado es sencillo para abrir, con promesas de complejidad detrás. Siento que la ciudad contiene la respiración.</p>
      <p>12. Despierto memorias: casos anteriores en los que el puzzle se transformó en venganza. Por eso cada movimiento lo pienso dos veces. Pero también sé apreciar la sofisticación cuando la veo.</p>
      <p>13. Lo que más me sorprende es la invitación a jugar con la identidad. "Nosotros somos parte del acertijo", dice una línea oculta entre los pliegues. Es como si me pidiera que me mostrara, que dejara de ocultarme en la función del vigilante.</p>
      <p>14. Ser Batxie es ser gesto y sombra; ser Ian es ser matiz y provocación. Quisiera que la ciudad comprendiera que ambos somos nombres, máscaras que a veces dicen la verdad.</p>
      <p>15. La falda verde en la foto no es mero accesorio: es señal. Ian invita a quienes se sienten fuera a jugar con esa identidad: a revelarla, a sentirla y a usarla como herramienta para comprender a la ciudad.</p>
      <p>16. Mis dedos recorren las letras del cifrado y me sorprendo: la solución es una instrucción. No me pide matarlo ni rendirme; me pide que vaya a un sitio. "Encuentra la falda verde en la plaza", susurra el papel.</p>
      <p>17. Me invade una mezcla de escepticismo y curiosidad. En el fondo sé que Ian juega con un motivo común: exponer, no destruir; atraer, no herir. Pero también sé que la exposición puede abrir heridas.</p>
      <p>18. Decido jugar su juego, por ahora. Si él quiere interrogatorio, le daré interrogatorios. Si quiere intercambio, le daré conversación. Pero no perderé el control.</p>
      <p>19. Mientras meto la carta en mi bolsillo, la lluvia borra parte del mensaje en la pared. Es un recordatorio: el tiempo trabaja para ambos. Si dejo que la espera crezca, perderé ventaja.</p>
      <p>20. Salgo en la noche como siempre: capa negra, flequillo cayendo sobre un ojo, la ciudad al filo. En mi libreta escribo la transcripción del cifrado. Mañana empezaré a descifrar. El juego comenzó.</p>

      <div class="muted-note">Ian usa su falda verde como firma visual. Batxie (tú) eres el vigilante emo que observa, descubre y a la vez se expone.</div>

      <div class="cipher-box" id="box1">
        <div><strong>Acertijo 1 — César (+3)</strong></div>
        <div><pre class="cipher">hqfxhqwud od idogd yhugh hq od sodcd</pre></div>

        <div class="controls" role="form" aria-label="Descifrado capítulo 1">
          <input id="answer1" type="text" placeholder="Ingresa la frase descifrada" aria-label="Respuesta capítulo 1"/>
          <button class="btn" onclick="check(1)">Verificar</button>
          <button class="ghost" onclick="hint(1,1)">Pista 1</button>
          <button class="ghost" onclick="hint(1,2)">Pista 2</button>
          <button class="ghost" onclick="hint(1,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(1)">Revelar</button>
        </div>
        <div class="hints">
          <div id="hint-1-1" class="hint">César: desplaza letras un número fijo.</div>
          <div id="hint-1-2" class="hint">Desplaza 3 posiciones hacia atrás (ej: d → a).</div>
          <div id="hint-1-3" class="hint">La frase empieza por "encuentra ...".</div>
        </div>
        <div id="result-1" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 2: Vigenère (clave 'memoria') ---------- -->
    <article class="chapter" id="cap2">
      <h2>Capítulo 2 — Primer Desafío Público (Vigenère)</h2>
      <!-- 20 párrafos -->
      <p>1. La fotografía de Ian se convierte en rumor. Las redes repiten su sonrisa; los cafés se llenan de susurros. Yo me paro en la penumbra y tomo notas.</p>
      <p>2. Ian avanza sin violencias: sus piezas piden colaboración, memoria, investigación. Eso lo hace peligroso en otra clave; obliga a la gente a mirarse a sí misma.</p>
      <p>3. En una plaza, un poema pegado en un poste prende la curiosidad de un grupo de jóvenes femboys. La palabra clave aparece en las primeras letras: una señal que remite a "memoria".</p>
      <p>4. Su elección de Vigenère no es casual: exige una clave con sentido humano. Quiere que quien lo resuelva recuerde para entender la pregunta.</p>
      <p>5. La gente se organiza: equipos de búsqueda, cafés con mapas, grupos que comparten ideas. Ian crea comunidad; y la ciudad responde con intensidad.</p>
      <p>6. Batxie, yo, observo desde arriba. Pregunto: ¿esto es arte o intervención social? Aun así, me interesa la topografía emocional que genera.</p>
      <p>7. Entre la multitud está la sombra de los emos: miradas largas, pañuelos negros, una música que acompaña la noche. Se siente una coreografía de identidades.</p>
      <p>8. Ian introduce una frase cifrada. Quien tenga la clave (memoria) sabrá que la intención es recordar, no provocar daño.</p>
      <p>9. En la parte inferior del poste hay una nota: "Loyxk qv tfu vfwf rjsx". La clave está oculta en una estrofa del poemario popular que guarda la biblioteca.</p>
      <p>10. Muchos lo intentan, pocos avanzan. Ian necesita que el enigma se vuelva conversación y eso sucede cuando extraños se ayudan.</p>
      <p>11. La comunidad emo-social se convierte en un equipo inesperado: femboys y emos colaboran en mesas improvisadas para descifrar la clave.</p>
      <p>12. La ética de Ian se vuelve visible: no hay trampas que humillen; las pistas secundarias protegen la vulnerabilidad de quienes participan.</p>
      <p>13. Yo, como Batxie, dejo una marca anónima: un símbolo que indica que observo. No intervengo; registro para entender motivaciones.</p>
      <p>14. La ciudad aprende a ver el enigma como puente: cuando una pista obliga a preguntar, los recuerdos resurgen y la memoria se re-activa.</p>
      <p>15. En la libreta de Ian hay una dedicatoria: "para quienes olvidaron cómo abrazarse". Esa línea cambia el sentido del juego.</p>
      <p>16. La pista Vigenère usa clave "memoria". La técnica es simple para quien la conoce; para los demás es invitación a aprender.</p>
      <p>17. El resultado del descifrado es una frase que conduce a una biblioteca: allí, un registro espera ser encontrado.</p>
      <p>18. La arquitectura de la ciudad se presta a su obra: vacíos, muros, placas; todo se incorpora como soporte del discurso.</p>
      <p>19. La búsqueda termina en casi una celebración: gente que antes no hablaba ahora comparte historias. Ese es el propósito real de Ian.</p>
      <p>20. Siento, por un momento, que la vigilancia y la provocación pueden ser diálogo. Ese pensamiento me desarma un poco.</p>

      <div class="cipher-box" id="box2">
        <div><strong>Acertijo 2 — Vigenère (clave: memoria)</strong></div>
        <div><pre class="cipher">Loyxk qv tfu vfwf rjsx</pre></div>

        <div class="controls">
          <input id="answer2" type="text" placeholder="Frase descifrada" />
          <button class="btn" onclick="check(2)">Verificar</button>
          <button class="ghost" onclick="hint(2,1)">Pista 1</button>
          <button class="ghost" onclick="hint(2,2)">Pista 2</button>
          <button class="ghost" onclick="hint(2,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(2)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-2-1" class="hint">Vigenère usa una palabra clave que se repite.</div>
          <div id="hint-2-2" class="hint">Clave: piensa en recordar, en español.</div>
          <div id="hint-2-3" class="hint">Clave exacta: memoria.</div>
        </div>
        <div id="result-2" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 3: Base64 ---------- -->
    <article class="chapter" id="cap3">
      <h2>Capítulo 3 — Ecos en Base64</h2>
      <p>1. La noche trae ecos. Ian pega un póster en un túnel del metro; en el póster solo hay una cadena extraña. Para muchos es ruido; para otros, invitación técnica.</p>
      <p>2. La elección de Base64 es pedagógica: es fácil de decodificar con herramientas mínimas; pero también obliga a que el curioso salga de su burbuja digital.</p>
      <p>3. Los femboys locales, que suelen compartir código en forums creativos, se vuelven claves informales en la resolución. Comparten pasos, enseñan cómo decodificar.</p>
      <p>4. Por la mañana alguien deja una nota: "dGVycm9yIG1lbW9yaWE=". La curiosidad crece y la plaza se convierte en aula improvisada.</p>
      <p>5. Batxie observa la energía: Ian no crea soledad con sus enigmas; crea aulas de colaboración que desafían la indiferencia.</p>
      <p>6. La respuesta en este caso es corta y directa; la importancia está en cómo genera comunidad para encontrarla.</p>
      <p>7. En la estación hay una vieja placa que relata un pequeño evento olvidado: el acertijo lo reaviva y une generaciones.</p>
      <p>8. Los que ayudan a descifrar se sienten dueños de la ciudad por un momento. Ian logra lo que buscó: responsabilidad compartida.</p>
      <p>9. La técnica Base64 no es el misterio; el misterio es qué se decide hacer con la información una vez se descubre.</p>
      <p>10. En la biblioteca, un grupo dedica la tarde a decodificar y a compartir historias; el efecto social es real.</p>
      <p>11. En mi cuaderno, dejo una anotación: "Ian utiliza el código para invitar a la memoria". Siento que su obra tiene intención pedagógica.</p>
      <p>12. El mensaje revela una palabra simple que enciende la siguiente pista; cada pequeño hallazgo construye el camino hacia el final.</p>
      <p>13. La técnica obliga a algunos a aprender nuevas herramientas; otros recuerdan viejos conocimientos y los comparten.</p>
      <p>14. El resultado final se convierte en un nombre que lleva a un pequeño altar urbano con flores y notas.</p>
      <p>15. Batxie, desde su sombra, observa cómo el dolor y la belleza se entrelazan en la reacción colectiva.</p>
      <p>16. A veces son las acciones pequeñas las que cambian la memoria de una ciudad. Esa es la hipótesis que Ian quiere probar.</p>
      <p>17. La base de su estrategia es simple: pon una pregunta, crea comunidad, deja rutas de reparación.</p>
      <p>18. Muchos no ven más allá de la novedad; otros se comprometen y reconstruyen vínculos. Ian sabe que ambos resultados existen y los acepta.</p>
      <p>19. La noche termina con un mural improvisado donde la palabra descifrada aparece dibujada con tiza verde.</p>
      <p>20. Para mí, el efecto es claro: Ian está reorganizando la ciudad con pequeñas intervenciones que parecen juegos, pero que funcionan como lecciones.</p>

      <div class="cipher-box" id="box3">
        <div><strong>Acertijo 3 — Base64</strong></div>
        <div><pre class="cipher">dGVycm9yIG1lbW9yaWE=</pre></div>

        <div class="controls">
          <input id="answer3" type="text" placeholder="Texto decodificado" />
          <button class="btn" onclick="check(3)">Verificar</button>
          <button class="ghost" onclick="hint(3,1)">Pista 1</button>
          <button class="ghost" onclick="hint(3,2)">Pista 2</button>
          <button class="ghost" onclick="hint(3,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(3)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-3-1" class="hint">Base64 es un encoding común en informática.</div>
          <div id="hint-3-2" class="hint">Puedes usar herramientas en línea o el decodificador del navegador.</div>
          <div id="hint-3-3" class="hint">Resulta en una palabra en español relacionada con memoria.</div>
        </div>

        <div id="result-3" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 4: Clave numérica / XOR ---------- -->
    <article class="chapter" id="cap4">
      <h2>Capítulo 4 — Señales en Hex/XOR</h2>
      <p>1. El atelier de Ian huele a perfume y a tinta. Allí mezcla papiros con códigos, telas con cifras; la falda verde cuelga como bandera silenciosa.</p>
      <p>2. Esta vez su pista viene en formato hex: una secuencia que no comenta a simple vista. Es un reto de manos y de cálculo.</p>
      <p>3. La técnica propone convertir hex a bytes y aplicar una operación XOR con una clave numérica. No es agresivo; es técnico.</p>
      <p>4. En una pequeña carta lateral Ian deja la sugerencia: "clave 42". Un guiño que algunos interpretan como humor intelectual.</p>
      <p>5. Los que saben de bytes se sienten en casa; otros aprenden en grupos y se acercan a la práctica con novedad.</p>
      <p>6. Batxie, curioso, intenta en la soledad de su auto patrulla; la operación revela una frase que apunta a un viejo teatro abandonado.</p>
      <p>7. Cuando llegan, encuentran una antigua butaca con la palabra de Ian cosida en la tela: un acto de memoria teatral.</p>
      <p>8. Para Ian el teatro es lugar de exposición pública; para Batxie es lugar de control emocional. Ambos lo comprenden a su modo.</p>
      <p>9. El hex elegido es técnico pero su finalidad es poética: devolver voz a un rincón olvidado de la ciudad.</p>
      <p>10. La tarea exige paciencia: quienes la resuelven suelen ser voluntarios que quieren formar parte del proceso.</p>
      <p>11. La clave numérica (42) es una broma y una referencia: la cifra sirve para desbloquear la instrucción siguiente.</p>
      <p>12. Los femboys del barrio usan lámparas y linternas para leer inscripciones históricas en el teatro; convierten el hallazgo en performance.</p>
      <p>13. Ian observa en silencio la escena en la distancia. Su obra no busca premios; busca impacto cotidiano.</p>
      <p>14. En los muros aparecen nuevas marcas: símbolos verdes que marcan rutas de memoria urbana.</p>
      <p>15. Batxie toma nota: lo que comenzó como reto mental se vuelve propuesta cultural.</p>
      <p>16. El enigma pide técnica; su resultado pide acción: plantar una flor, registrar un nombre, limpiar una placa.</p>
      <p>17. La ciudad se presta, con riesgo y con belleza, a la propuesta experimental de Ian.</p>
      <p>18. Los que resuelven reciben una pequeña carta adicional firmada: "gracias por recordar".</p>
      <p>19. Para mí, ese gesto confirma un efecto: las pruebas pueden activar labores de reparación social con interpretación estética.</p>
      <p>20. La noche cierra con la sensación de que la cifra 42 fue más que broma: fue permiso simbólico para continuar.</p>

      <div class="cipher-box" id="box4">
        <div><strong>Acertijo 4 — Hex → XOR (clave: 42)</strong></div>
        <div><pre class="cipher">48656c6c6f2c20476f7468616d</pre></div>

        <div class="controls">
          <input id="answer4" type="text" placeholder="Resultado ASCII tras XOR" />
          <button class="btn" onclick="check(4)">Verificar</button>
          <button class="ghost" onclick="hint(4,1)">Pista 1</button>
          <button class="ghost" onclick="hint(4,2)">Pista 2</button>
          <button class="ghost" onclick="hint(4,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(4)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-4-1" class="hint">Convierte el hex a bytes.</div>
          <div id="hint-4-2" class="hint">Aplica XOR a cada byte con la clave 42.</div>
          <div id="hint-4-3" class="hint">Lee el resultado como ASCII.</div>
        </div>
        <div id="result-4" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 5: Atbash ---------- -->
    <article class="chapter" id="cap5">
      <h2>Capítulo 5 — Espejos (Atbash)</h2>
      <p>1. Ian dibuja espejos en los muros: símbolos que funcionan en espejo. Atbash es su herramienta para crear inversión de sentido.</p>
      <p>2. La técnica invierte alfabeto: A ↔ Z. Lo que parecía claro se vuelve oscuro; lo escondido aparece como reflejo.</p>
      <p>3. En un retrato pegado en una calle hay una inscripción: "svool dliow". Bastará invertir para leerla.</p>
      <p>4. Para muchos es sencillo; para otros es experiencia de literalidad transformada.</p>
      <p>5. Ian juega con idea de que la verdad a veces es la inversión de lo evidente.</p>
      <p>6. Batxie toma la inscripción y la mira; la decodificación revela un nombre que conduce a un bar donde la ciudad llora.</p>
      <p>7. En ese bar, femboys y emos comparten historias; el ambiente se vuelve catártico y tenso.</p>
      <p>8. Ian no desea dañar; desea que la verdad, vista en espejo, active conversación.</p>
      <p>9. El Atbash obliga a mirar al revés, a aceptar que las respuestas pueden estar escondidas en la estructura.</p>
      <p>10. Los participantes comparten risas y silencios. La ciudad vuelve a nombrar aquello que había callado.</p>
      <p>11. Para mí, Batxie, la experiencia es curiosa: un espejo que obliga a enfrentar la propia mirada.</p>
      <p>12. Ian escribe una nota: "Refleja y elige". El enigma no juzga; ofrece opciones.</p>
      <p>13. Algunos salen ofendidos; otros agradecen. El balance social es impreciso pero real.</p>
      <p>14. El bar se convierte en pequeño laboratorio de memoria; la música emo envuelve la escena.</p>
      <p>15. La falda verde aparece en la esquina del escenario. El símbolo se reafirma como firma.</p>
      <p>16. En mi libreta anoto: "Ian no busca reconocimiento. Busca conversación y culpa compartida".</p>
      <p>17. Las superficies brillan con la lluvia; las letras invertidas se vuelven más legibles con los reflejos.</p>
      <p>18. El enigma del espejo demuestra que el significado es una decisión de lectura.</p>
      <p>19. Al salir, una persona me agradece por haber observado. No sé si merezco el agradecimiento.</p>
      <p>20. Me pregunto cuánto tiempo más seguirá este juego antes de que la ciudad decida la última palabra.</p>

      <div class="cipher-box" id="box5">
        <div><strong>Acertijo 5 — Atbash</strong></div>
        <div><pre class="cipher">svool dliow</pre></div>

        <div class="controls">
          <input id="answer5" type="text" placeholder="Frase descifrada" />
          <button class="btn" onclick="check(5)">Verificar</button>
          <button class="ghost" onclick="hint(5,1)">Pista 1</button>
          <button class="ghost" onclick="hint(5,2)">Pista 2</button>
          <button class="ghost" onclick="hint(5,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(5)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-5-1" class="hint">Atbash invierte el alfabeto (A↔Z, B↔Y...)</div>
          <div id="hint-5-2" class="hint">Prueba invertir cada letra según A↔Z.</div>
          <div id="hint-5-3" class="hint">Resulta en una frase simple en inglés: "hello world".</div>
        </div>

        <div id="result-5" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 6: Binario ---------- -->
    <article class="chapter" id="cap6">
      <h2>Capítulo 6 — Dígitos y Silencios (Binario)</h2>
      <p>1. Ian convierte palabras en pulsos: en un poste pone una secuencia de 0 y 1. Para decodificar se necesita paciencia y traducción a ASCII.</p>
      <p>2. La secuencia no es larga, pero exige que el lector deje de lado la inmediatez y traduzca con calma.</p>
      <p>3. En un taller nocturno, femboys enseñan a transformar binario a caracteres; la escena se vuelve práctica colaborativa.</p>
      <p>4. Para Ian el binario es un gesto: lo básico que sirve para construir el puente entre la técnica y la memoria.</p>
      <p>5. En la noche el binario se convierte en mural de luz; las linternas ayudan a que quien pasa lo lea con atención.</p>
      <p>6. Para mí, Batxie, la experiencia es educativa: la ciudad aprende a traducir lo que antes parecía ruido.</p>
      <p>7. El resultado dirige a una placa con nombres; la comunidad añade una flor y una nota.</p>
      <p>8. El enigma de dígitos demuestra que incluso los códigos más fríos pueden cargar humanidad.</p>
      <p>9. En la biblioteca un pequeño grupo convierte el mensaje y celebra con té. La ciudad, por un rato, parece corresponder.</p>
      <p>10. La técnica de Ian busca que más personas aprendan herramientas de traducción cultural.</p>
      <p>11. La traducción a ASCII revela una frase breve que invita a un encuentro nocturno.</p>
      <p>12. Muchos llegan, algunos por curiosidad, otros por necesidad de contacto.</p>
      <p>13. La señal binaria se vuelve contenido para redes; otros la convierten en canción.</p>
      <p>14. Ian sonríe en la distancia; su obra funciona como motor de redes comunitarias.</p>
      <p>15. En mi libreta anoto coordenadas; la ciudad ya no es solo sombras sino topografías de memoria.</p>
      <p>16. Los que aprendieron binario comparten la técnica con otros; la alfabetización digital se hace práctica colectiva.</p>
      <p>17. El ruido se convierte en conversación y su resultado en acción simbólica.</p>
      <p>18. El enigma demuestra que la técnica no excluye la sensibilidad; puede ser puente si se diseña con cuidado.</p>
      <p>19. Al final, una pequeña reunión en la plaza celebra el tiempo compartido en alfabetos diferentes.</p>
      <p>20. Me quedo con la idea de Ian: el código es una excusa para que la gente se encuentre.</p>

      <div class="cipher-box" id="box6">
        <div><strong>Acertijo 6 — Binario (ASCII)</strong></div>
        <div><pre class="cipher">01100101 01101110 01100011 01110101 01100101 01101110 01110100 01110010 01100001</pre></div>

        <div class="controls">
          <input id="answer6" type="text" placeholder="Texto decodificado (ASCII)" />
          <button class="btn" onclick="check(6)">Verificar</button>
          <button class="ghost" onclick="hint(6,1)">Pista 1</button>
          <button class="ghost" onclick="hint(6,2)">Pista 2</button>
          <button class="ghost" onclick="hint(6,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(6)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-6-1" class="hint">Agrupa por bytes (8 dígitos) y convierte a decimal, luego a ASCII.</div>
          <div id="hint-6-2" class="hint">Cada bloque es una letra ASCII en binario.</div>
          <div id="hint-6-3" class="hint">El resultado en español comienza con "encuentra".</div>
        </div>

        <div id="result-6" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 7: Esteganografía simple (mensaje en atributo data-hidden) ---------- -->
    <article class="chapter" id="cap7">
      <h2>Capítulo 7 — Imagenes que Callan (Esteganografía)</h2>
      <p>1. Ian pega un retrato en un muro: su falda verde destaca. A simple vista, es solo imagen. Pero Ian dejó algo oculto dentro: un mensaje en el soporte mismo.</p>
      <p>2. La esteganografía puede ser compleja; aquí usamos una forma sencilla: el mensaje aparece en un metadato o atributo que solo se revela si se mira con atención técnica.</p>
      <p>3. El retrato tiene un atributo `data-hidden` con texto cifrado. Para muchas personas esto no sería esteganografía avanzada, pero cualquiera puede aprender a inspeccionar.</p>
      <p>4. El truco es educativo: enseña que las imágenes pueden portar mensajes y que la curiosidad técnica abre puertas.</p>
      <p>5. En el mural, la imagen de Ian tiene `data-hidden="VGhlIG1lc3NhZ2UgaW4gaXMgaGFkZQ=="` — una cadena Base64.</p>
      <p>6. Los que saben decodifican y encuentran una instrucción: una hora, un banco y una flor verde esperándolos.</p>
      <p>7. La esteganografía simple evita daño y sirve para enlazar pistas de manera creativa.</p>
      <p>8. Muchos aprenden por primera vez qué significa "inspeccionar elemento". La alfabetización técnica se vuelve real.</p>
      <p>9. En la noche, la gente llega con linternas; las flores verdes aparecen en el banco indicado.</p>
      <p>10. Ian observa a distancia; su sonrisa es pequeña y satisfecha.</p>
      <p>11. Batxie toma nota: los métodos no importan tanto como la intención detrás de ellos.</p>
      <p>12. Para algunos, la esteganografía parece trampa; para otros, es lección de curiosidad.</p>
      <p>13. En la plaza, un vínculo efímero se crea: desconocidos comparten linterna y conocimiento.</p>
      <p>14. Ian firma en la nube: su falda verde vuelve a aparecer y sirve de faro visual.</p>
      <p>15. La lección técnica se vuelve práctica comunitaria: se comparten pasos para decodificar y luego para actuar.</p>
      <p>16. La esteganografía se revela como herramienta pedagógica en manos de alguien con ética.</p>
      <p>17. El pequeño ritual en el banco se repite y la ciudad integra el gesto en su memoria urbana.</p>
      <p>18. Para mí, ver a la gente aprender y reunirse es la recompensa de vigilar.</p>
      <p>19. Ian ha logrado una red de enseñanza, no una conspiración.</p>
      <p>20. La imagen dice más que su estética: dice "busca y aprenderás".</p>

      <div class="cipher-box" id="box7">
        <div><strong>Acertijo 7 — Esteganografía simple (mensaje oculto en la imagen)</strong></div>
        <div>
          <p>Inspecciona el atributo <code>data-hidden</code> de la imagen de Ian arriba (o usa la herramienta de inspección del navegador) y decodifica la cadena Base64.</p>
          <img id="stegoImg" class="portrait" src="3fa61b2b-003e-4b15-90b5-442a04d03e7a.jpg" alt="Retrato de Ian (contiene mensaje oculto)" data-hidden="VGhlIG1lc3NhZ2UgaW4gaXMgaGFkZQ==" style="max-width:260px; display:block; margin:12px auto;"/>
        </div>

        <div class="controls">
          <input id="answer7" type="text" placeholder="Mensaje decodificado" />
          <button class="btn" onclick="check(7)">Verificar</button>
          <button class="ghost" onclick="hint(7,1)">Pista 1</button>
          <button class="ghost" onclick="hint(7,2)">Pista 2</button>
          <button class="ghost" onclick="hint(7,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(7)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-7-1" class="hint">Busca el atributo data-hidden en la imagen (inspeccionar elemento).</div>
          <div id="hint-7-2" class="hint">La cadena es Base64.</div>
          <div id="hint-7-3" class="hint">Decodificar Base64 te dará una frase corta (en inglés).</div>
        </div>

        <div id="result-7" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 8: Morse ---------- -->
    <article class="chapter" id="cap8">
      <h2>Capítulo 8 — Ritmos en Código (Morse)</h2>
      <p>1. En una farola, Ian cuelga un pequeño tablero con rayas y puntos; por la noche, las linternas proyectan el patrón como morse.</p>
      <p>2. El código Morse es antiguo pero eficaz: obliga al lector a escuchar ritmo y a traducir sonido o puntos.</p>
      <p>3. En un taller comunitario, se enseña a traducir; los más jóvenes se sorprenden de que sigan existiendo alfabetos de urgencia.</p>
      <p>4. La frase resulta ser una dirección abreviada; todos la anotan en sus libretas y comienzan la marcha.</p>
      <p>5. Ian contempla el movimiento desde la distancia; su juego activa patrones colectivos de búsqueda.</p>
      <p>6. El morse funciona como puente entre generaciones: los mayores recuerdan prácticas y las comparten.</p>
      <p>7. Batxie evalúa el patrón: la repetición muestra intención de cuidado (no daño).</p>
      <p>8. En algún punto, la tensión entre investigación y espectáculo se vuelve diálogo claro entre comunidades.</p>
      <p>9. La acción termina con una ofrenda: una pequeña caja con papeles que contienen nombres y recuerdos.</p>
      <p>10. El morse demuestra que los signos simples pueden provocar encuentros significativos.</p>
      <p>11. La gente aprende que decodificar es un acto de paciencia y de escucha.</p>
      <p>12. Ian observa cómo su proyecto deja huellas concretas: nombres que son leídos en voz alta en la plaza.</p>
      <p>13. Para mí, ese sonido de puntos y rayas es música de ciudad que pide atención.</p>
      <p>14. La noche concluye con un susurro colectivo: la memoria reconocida hace que la culpa se vuelva reparable.</p>
      <p>15. En el recorrido, muchos se reconocen en historias ajenas; el morse fue la excusa para hablar.</p>
      <p>16. La técnica funciona; el efecto también. Ian consigue transformar regla en ritual.</p>
      <p>17. A veces me pregunto si su arte es manipulación o catalizador; la respuesta depende de quien la viva.</p>
      <p>18. La ciudad aprende que los códigos también son poemas cuando se comparte su traducción.</p>
      <p>19. Ian sonríe en la penumbra; su falda verde ondea como bandera en la memoria colectiva.</p>
      <p>20. Yo guardo los sonidos en mi libreta; la vigilancia incluye ahora la escucha cultural.</p>

      <div class="cipher-box" id="box8">
        <div><strong>Acertijo 8 — Morse</strong></div>
        <div><pre class="cipher">.-. .-.. .- -- .-   .- .-.. .-   .--. .-.. .- -- .</pre></div>

        <div class="controls">
          <input id="answer8" type="text" placeholder="Texto decodificado (palabras)" />
          <button class="btn" onclick="check(8)">Verificar</button>
          <button class="ghost" onclick="hint(8,1)">Pista 1</button>
          <button class="ghost" onclick="hint(8,2)">Pista 2</button>
          <button class="ghost" onclick="hint(8,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(8)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-8-1" class="hint">.-. = R, .-.. = L, .- = A, -- .- = MA, etc.</div>
          <div id="hint-8-2" class="hint">Divide por palabras (espacio doble o triple).</div>
          <div id="hint-8-3" class="hint">Resultado en español forma una instrucción corta.</div>
        </div>

        <div id="result-8" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 9: Combo (Vigenère + Base64) ---------- -->
    <article class="chapter" id="cap9">
      <h2>Capítulo 9 — Capas (Vigenère + Base64)</h2>
      <p>1. A estas alturas el juego necesita ingenio. Ian entrega una cadena que primero debe decodificarse desde Base64 y luego pasarse por Vigenère.</p>
      <p>2. La capa doble exige colaboración: quien domina una técnica ayuda al que domina la otra; la comunidad se vuelve esencial.</p>
      <p>3. La clave Vigenère es una palabra que conecta con la memoria urbana: "gotham".</p>
      <p>4. El binomio técnico es una prueba final antes del cierre: quien lo resuelve tendrá pista para el rompecabezas mayor.</p>
      <p>5. En los muros aparecen instrucciones parciales; la gente organiza guardias nocturnas para resolver en equipo.</p>
      <p>6. Ian observa la red de nuevas amistades; su objetivo era también social, no solo intelectual.</p>
      <p>7. Batxie verifica la cadena en su cuaderno; la tensión llega a su punto máximo: casi todo está listo para el cierre.</p>
      <p>8. La doble decodificación revela una coordenada: un punto en el mapa donde la ciudad discute su historia.</p>
      <p>9. La emoción es intensa: personas que no se conocían antes se ayudan y celebran en la oscuridad.</p>
      <p>10. La cooperación demuestra que el enigma puede ser un pegamento social cuando se diseña con cuidado.</p>
      <p>11. La clave "gotham" fortalece la idea de que los acertijos de Ian están enraizados en lugar y memoria.</p>
      <p>12. La cadena final dirige a una placa que se limpia y se vuelve memoria pública restaurada.</p>
      <p>13. El proceso demuestra que la técnica y la ética pueden mezclarse productivamente.</p>
      <p>14. Para Ian, es un éxito: su obra activa reparación, participación y conversación.</p>
      <p>15. Para mí, es lección: la vigilancia puede acompañar procesos culturales sin destruirlos.</p>
      <p>16. La noche anterior al cierre, se siente una calma eléctrica. La ciudad está lista para la conclusión.</p>
      <p>17. Muchos participantes reciben una carta de agradecimiento con su nombre bordado: el efecto es tangible.</p>
      <p>18. La cooperación demuestra que el enigma fomenta comunidad cuando respeta la vulnerabilidad.</p>
      <p>19. A días del final, las calles muestran rastros verdes y música emo suave en los bares.</p>
      <p>20. Lo que comenzó como juego ahora es política de memoria; Ian nos llevó a eso, y la ciudad respondió.</p>

      <div class="cipher-box" id="box9">
        <div><strong>Acertijo 9 — Base64 → Vigenère (clave: gotham)</strong></div>
        <div><pre class="cipher">WWp0dXkgbSByc3Q=</pre></div>

        <div class="controls">
          <input id="answer9" type="text" placeholder="Texto final (después de dos pasos)" />
          <button class="btn" onclick="check(9)">Verificar</button>
          <button class="ghost" onclick="hint(9,1)">Pista 1</button>
          <button class="ghost" onclick="hint(9,2)">Pista 2</button>
          <button class="ghost" onclick="hint(9,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(9)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-9-1" class="hint">Primero decodifica Base64.</div>
          <div id="hint-9-2" class="hint">Luego aplica Vigenère con clave "gotham".</div>
          <div id="hint-9-3" class="hint">El resultado es una frase corta en español.</div>
        </div>

        <div id="result-9" class="result"></div>
      </div>
    </article>

    <!-- ---------- CHAPTER 10: Final Composite ---------- -->
    <article class="chapter" id="cap10">
      <h2>Capítulo 10 — El Rompecabezas Final</h2>
      <p>1. Ian convoca la noche del cierre: una instalación que resume las acciones previas. Las pistas previas son necesarias para montar la pieza final.</p>
      <p>2. El rompecabezas final combina elementos: una frase final codificada con Playfair (clave: "enigma"), un número que requiere binario y una imagen con estego que confirma el cierre.</p>
      <p>3. Quien tenga las respuestas parciales logradas en capítulos anteriores tendrá ventaja para recomponer el todo.</p>
      <p>4. Ian no busca venganza ni gloria; busca que la ciudad se mire y actúe. Su objetivo es conversación pública sostenida.</p>
      <p>5. Batxie y yo (la función del lector) estamos en el centro: nuestra tarea es decidir cómo actuar con la información.</p>
      <p>6. La pieza final exige ética: no publicar todo sin contexto, ofrecer rutas de reparación y compartir el reconocimiento.</p>
      <p>7. Ian prepara una última frase cifrada con Playfair 5x5, clave "enigma". Su lectura exige el uso de un decodificador que está integrado aquí.</p>
      <p>8. El resultado conduce a un acto público simbólico: plantar árboles en memoria de personas olvidadas por la ciudad.</p>
      <p>9. En la noche del cierre, muchos participan, lloran y celebran; emo y femboy, vigilante y creador, convergen en un gesto de cuidado.</p>
      <p>10. El rompecabezas final es menos un premio y más una convocatoria para seguir trabajando en comunidad.</p>
      <p>11. La técnica (Playfair) obliga a la colaboración: no es trivial, pero tampoco inaccesible.</p>
      <p>12. La clave "enigma" es simple y simbólica: recuerda que el proceso de preguntar es más importante que la respuesta definitiva.</p>
      <p>13. Mi libreta registra: "El Acertijo femboy enseñó que las preguntas compartidas cambian la ciudad".</p>
      <p>14. La noche se cierra con el acto simbólico: la ciudad planta, escucha y promete mantener memoria colectiva.</p>
      <p>15. Ian desaparece en la penumbra con su falda verde; su figura deja huella y nombre, pero también preguntas pendientes.</p>
      <p>16. Batxie observa el resultado y siente que algo se ha transformado; la vigilancia se convierte en escucha y acompañamiento.</p>
      <p>17. En mi libreta entrego la última nota: "No es victoria de ninguno; es posibilidad de muchos".</p>
      <p>18. La memoria urbana ahora tiene un mapa nuevo: pistas, nombres, actos y una red que puede sostenerse.</p>
      <p>19. Ian firmó su obra con un gesto sencillo: una falda verde colgada en un árbol, como recordatorio y llama.</p>
      <p>20. Al final, queda la pregunta: ¿qué harás con lo que aprendiste? El lector/ Batxie decide cómo usar la respuesta.</p>

      <div class="cipher-box" id="box10">
        <div><strong>Acertijo 10 — Playfair (clave: enigma)</strong></div>
        <div><pre class="cipher">GATLM ZGJTW</pre></div>

        <div class="controls">
          <input id="answer10" type="text" placeholder="Frase final descifrada" />
          <button class="btn" onclick="check(10)">Verificar</button>
          <button class="ghost" onclick="hint(10,1)">Pista 1</button>
          <button class="ghost" onclick="hint(10,2)">Pista 2</button>
          <button class="ghost" onclick="hint(10,3)">Pista 3</button>
          <button class="ghost" onclick="reveal(10)">Revelar</button>
        </div>

        <div class="hints">
          <div id="hint-10-1" class="hint">Playfair usa una matriz 5x5; J se une con I.</div>
          <div id="hint-10-2" class="hint">Clave: enigma (sin comillas).</div>
          <div id="hint-10-3" class="hint">Resultado es una frase corta que conecta con la acción final (plantar/recordar).</div>
        </div>

        <div id="result-10" class="result"></div>
      </div>
    </article>

    <footer>
      <p>Libro interactivo: usa los descifradores integrados. Las pistas progresivas ayudan; si quieres que alguna pista se desbloquee solo tras X intentos o que el final requiera todas las respuestas previas correctas, lo programo enseguida.</p>
    </footer>
  </div>

<script>
/* ----------------- Decoders & Helpers ----------------- */
/* Caesar decode */
function caesarDecodeStr(s, shift){
  shift = ((shift%26)+26)%26;
  let out='';
  for(let i=0;i<s.length;i++){
    const ch = s[i];
    if(ch >= 'a' && ch <= 'z'){
      let code = ch.charCodeAt(0)-97;
      out += String.fromCharCode(((code - shift + 26) % 26) + 97);
    } else if(ch >= 'A' && ch <= 'Z'){
      let code = ch.charCodeAt(0)-65;
      out += String.fromCharCode(((code - shift + 26) % 26) + 65);
    } else out += ch;
  }
  return out;
}

/* Vigenère decode */
function vigenereDecode(str, key){
  if(!key) return str;
  key = key.replace(/[^A-Za-z]/g,'').toLowerCase();
  let out=''; let ki=0;
  for(let ch of str){
    if(/[a-zA-Z]/.test(ch)){
      const base = (ch === ch.toUpperCase()) ? 65 : 97;
      const code = ch.charCodeAt(0)-base;
      const k = key[ki % key.length].charCodeAt(0)-97;
      const dec = (code - k + 26) % 26;
      out += String.fromCharCode(dec + base);
      ki++;
    } else out += ch;
  }
  return out;
}

/* Base64 decode (utf8 safe) */
function base64Decode(s){
  try{
    return decodeURIComponent(escape(window.atob(s)));
  }catch(e){
    try{ return window.atob(s); }catch(e2){ return 'Error Base64'; }
  }
}

/* XOR from hex */
function xorFromHex(hexStr, key){
  try{
    const k = parseInt(key);
    if(isNaN(k)) return 'Clave no numérica';
    hexStr = hexStr.replace(/\s+/g,'');
    if(hexStr.length % 2 !== 0) return 'Hex inválido';
    let out='';
    for(let i=0;i<hexStr.length;i+=2){
      const byte = parseInt(hexStr.substr(i,2),16);
      out += String.fromCharCode(byte ^ k);
    }
    return out;
  }catch(e){ return 'Error XOR'; }
}

/* Atbash */
function atbashDecode(s){
  let out='';
  for(let ch of s){
    if(/[A-Z]/.test(ch)){
      out += String.fromCharCode(65 + (25 - (ch.charCodeAt(0)-65)));
    } else if(/[a-z]/.test(ch)){
      out += String.fromCharCode(97 + (25 - (ch.charCodeAt(0)-97)));
    } else out += ch;
  }
  return out;
}

/* Binary to ASCII */
function binaryToAscii(s){
  const parts = s.trim().split(/\s+/);
  let out='';
  for(let p of parts){
    const code = parseInt(p,2);
    if(isNaN(code)) return 'Binario inválido';
    out += String.fromCharCode(code);
  }
  return out;
}

/* Morse */
const MORSE = {
'.-':'A','-...':'B','-.-.':'C','-..':'D','.':'E','..-.':'F','--.':'G','....':'H','..':'I',
'.---':'J','-.-':'K','.-..':'L','--':'M','-.':'N','---':'O','.--.':'P','--.-':'Q','.-.':'R',
'...':'S','-':'T','..-':'U','...-':'V','.--':'W','-..-':'X','-.--':'Y','--..':'Z',
'-----':'0','.----':'1','..---':'2','...--':'3','....-':'4','.....':'5','-....':'6','--...':'7','---..':'8','----.':'9',
'.-.-.-':'.','--..--':',','..--..':'?','-.-.--':'!','-....-':'-','-.--.':'(','-.--.-':')','/':' '
};
function morseDecode(s){
  const words = s.trim().split('   ');
  const outWords = words.map(w => w.split(' ').map(sym => MORSE[sym] || '?').join(''));
  return outWords.join(' ');
}

/* Playfair simplistic decode (as implemented earlier) */
function playfairGenerateSquare(key){
  key = key.toUpperCase().replace(/J/g,'I').replace(/[^A-Z]/g,'');
  const seen={}; const arr=[];
  for(let ch of key) if(!seen[ch]){ seen[ch]=1; arr.push(ch); }
  for(let i=65;i<=90;i++){
    const ch=String.fromCharCode(i);
    if(ch==='J') continue;
    if(!seen[ch]){ seen[ch]=1; arr.push(ch); }
  }
  const matrix=[];
  for(let r=0;r<5;r++) matrix.push(arr.slice(r*5,(r+1)*5));
  return matrix;
}
function playfairFind(matrix,ch){
  for(let r=0;r<5;r++) for(let c=0;c<5;c++) if(matrix[r][c]===ch) return {r,c};
  return null;
}
function playfairPairs(text){
  text = text.toUpperCase().replace(/J/g,'I').replace(/[^A-Z]/g,'');
  const pairs=[];
  for(let i=0;i<text.length;){
    const a = text[i];
    let b = text[i+1] || 'X';
    if(a===b){ b='X'; i+=1; } else i+=2;
    pairs.push(a+b);
  }
  return pairs;
}
function playfairDecode(ciphertext,key){
  try{
    const matrix = playfairGenerateSquare(key);
    const pairs = playfairPairs(ciphertext);
    let out='';
    for(let pair of pairs){
      const A = playfairFind(matrix,pair[0]);
      const B = playfairFind(matrix,pair[1]);
      if(A.r === B.r){
        out += matrix[A.r][(A.c+4)%5] + matrix[B.r][(B.c+4)%5];
      } else if(A.c === B.c){
        out += matrix[(A.r+4)%5][A.c] + matrix[(B.r+4)%5][B.c];
      } else {
        out += matrix[A.r][B.c] + matrix[B.r][A.c];
      }
    }
    return out;
  }catch(e){ return 'Error Playfair'; }
}

/* Utility: normalize strings for comparison */
function normalizeAnswer(s){
  return (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase();
}

/* HINT / REVEAL MANAGEMENT: progressive hints for each chapter tracked by shown flags */
const HINTS_SHOWN = {}; // e.g. HINTS_SHOWN['1'] = {1:true,2:false,3:false}

function hint(ch, n){
  const id = `hint-${ch}-${n}`;
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = 'block';
  // record shown
  HINTS_SHOWN[ch] = HINTS_SHOWN[ch] || {};
  HINTS_SHOWN[ch][n] = true;
  el.scrollIntoView({behavior:'smooth', block:'center'});
}

/* REVEAL partial (shows decoded answer computed automatically where possible) */
function reveal(ch){
  // Try to auto-decode based on known chapter rules
  let decoded = '';
  if(ch===1){
    decoded = caesarDecodeStr(document.querySelector('#cap1 .cipher').innerText, 3);
  } else if(ch===2){
    decoded = vigenereDecode(document.querySelector('#cap2 .cipher').innerText, 'memoria');
  } else if(ch===3){
    decoded = base64Decode(document.querySelector('#cap3 .cipher').innerText);
  } else if(ch===4){
    decoded = xorFromHex(document.querySelector('#cap4 .cipher').innerText, '42');
  } else if(ch===5){
    decoded = atbashDecode(document.querySelector('#cap5 .cipher').innerText);
  } else if(ch===6){
    decoded = binaryToAscii(document.querySelector('#cap6 .cipher').innerText);
  } else if(ch===7){
    const img = document.getElementById('stegoImg');
    const hidden = img ? img.getAttribute('data-hidden') : '';
    decoded = base64Decode(hidden || '');
  } else if(ch===8){
    decoded = morseDecode(document.querySelector('#cap8 .cipher').innerText);
  } else if(ch===9){
    const b64 = document.querySelector('#cap9 .cipher').innerText;
    const mid = base64Decode(b64);
    decoded = vigenereDecode(mid, 'gotham');
  } else if(ch===10){
    decoded = playfairDecode(document.querySelector('#cap10 .cipher').innerText.replace(/\s+/g,''), 'enigma');
  }
  const out = document.getElementById('result-'+ch);
  if(out){
    out.style.color = 'lightgreen';
    out.innerText = 'Ayuda parcial (revelada automáticamente):\n' + decoded;
    out.scrollIntoView({behavior:'smooth', block:'center'});
  }
}

/* CHECK function for all chapters mapping to decoding logic and expected plaintexts */
function check(ch){
  const userEl = document.getElementById('answer'+ch);
  if(!userEl) return;
  const user = normalizeAnswer(userEl.value);
  let expectedRaw = '';
  let decoded = '';
  if(ch===1){
    decoded = caesarDecodeStr(document.querySelector('#cap1 .cipher').innerText, 3);
    expectedRaw = decoded;
  } else if(ch===2){
    decoded = vigenereDecode(document.querySelector('#cap2 .cipher').innerText, 'memoria');
    expectedRaw = decoded;
  } else if(ch===3){
    decoded = base64Decode(document.querySelector('#cap3 .cipher').innerText);
    expectedRaw = decoded;
  } else if(ch===4){
    decoded = xorFromHex(document.querySelector('#cap4 .cipher').innerText, '42');
    expectedRaw = decoded;
  } else if(ch===5){
    decoded = atbashDecode(document.querySelector('#cap5 .cipher').innerText);
    expectedRaw = decoded;
  } else if(ch===6){
    decoded = binaryToAscii(document.querySelector('#cap6 .cipher').innerText);
    expectedRaw = decoded;
  } else if(ch===7){
    const img = document.getElementById('stegoImg');
    const hid = img ? img.getAttribute('data-hidden') : '';
    decoded = base64Decode(hid);
    expectedRaw = decoded;
  } else if(ch===8){
    decoded = morseDecode(document.querySelector('#cap8 .cipher').innerText);
    expectedRaw = decoded;
  } else if(ch===9){
    const mid = base64Decode(document.querySelector('#cap9 .cipher').innerText);
    decoded = vigenereDecode(mid, 'gotham');
    expectedRaw = decoded;
  } else if(ch===10){
    decoded = playfairDecode(document.querySelector('#cap10 .cipher').innerText.replace(/\s+/g,''), 'enigma');
    expectedRaw = decoded;
  }
  const out = document.getElementById('result-'+ch);
  if(normalizeAnswer(expectedRaw) === normalizeAnswer(user)){
    out.style.color = 'lime';
    out.innerText = '✔ Correcto — ' + expectedRaw + '\nPista siguiente desbloqueada.';
  } else {
    out.style.color = 'salmon';
    out.innerText = '✘ Incorrecto. Reintenta o pide una pista.';
  }
  out.scrollIntoView({behavior:'smooth', block:'center'});
}

/* Init: ensure each chapter's cipher text element has class .cipher for selection (done inline),
   and set accessible IDs where needed. */

/* Accessibility: allow Enter key to submit in current chapter input */
document.addEventListener('keydown', function(e){
  if(e.key === 'Enter'){
    const active = document.activeElement;
    if(active && active.id && active.id.startsWith('answer')){
      const ch = active.id.replace('answer','');
      check(parseInt(ch));
    }
  }
});
</script>
</body>
</html>
